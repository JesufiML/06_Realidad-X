<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      #example-scanning-overlay {
        position: absolute;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #example-scanning-overlay.hidden { display: none; }
      #scanning-box {
        width: 250px; height: 250px;
        border: 4px solid white;
        position: relative;
        overflow: hidden;
        background: transparent;
      }
      #scanning-line {
        position: absolute; top: 0; left: 0;
        width: 100%; height: 4px;
        background: rgba(0, 255, 0, 0.8);
        animation: scanning 2s linear infinite;
      }
      @keyframes scanning { 0% { top: 0; } 100% { top: 100%; } }
      #scan-text {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 16px;
        text-align: center;
        padding: 5px;
      }
      .tap-hint {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        background: rgba(0,0,0,0.7);
        padding: 10px;
        border-radius: 10px;
        display: none;
        z-index: 10000;
        font-family: Arial, sans-serif;
      }
    </style>
  </head>

  <body>
    <!-- Overlay de escaneo -->
    <div id="example-scanning-overlay">
      <div id="scanning-box">
        <p id="scan-text">Localiza los targets correctos para ver los modelos 3D</p>
        <div id="scanning-line"></div>
      </div>
    </div>

    <!-- Indicador de tap -->
    <div id="tap-hint" class="tap-hint">Toca el modelo para cambiarlo</div>

    <!-- Escena MindAR -->
    <a-scene 
      mindar-image="uiScanning: #example-scanning-overlay; imageTargetSrc: ./targets.mind; maxTrack: 2"
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">

      <!-- Assets -->
      <a-assets>
        <img id="card" src="FondoPokebola.jpg" />
        <a-asset-item id="avatarModel1" src="./Charmander.glb"></a-asset-item>
        <a-asset-item id="avatarModel2" src="./Pikachu.glb"></a-asset-item>
        <a-asset-item id="avatarModel3" src="./pokeball.glb"></a-asset-item>
      </a-assets>

      <!-- Cámara -->
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Target 1: Charmander -->
      <a-entity mindar-image-target="targetIndex: 0" id="target0">
        <a-plane src="#card" position="0 0 0" height="0.552" width="1" 
                 class="clickable" data-target-index="0"></a-plane>
        <a-gltf-model id="model1"
          gltf-model="#avatarModel1"
          position="0 0 0.1" 
          scale="0.7 0.7 0.7"
          rotation="0 180 0"
          animation-mixer
          class="clickable" data-target-index="0">
        </a-gltf-model>
      </a-entity>

      <!-- Target 2: Pikachu -->
      <a-entity mindar-image-target="targetIndex: 1" id="target1">
        <a-plane src="#card" position="0 0 0" height="0.552" width="1" 
                 class="clickable" data-target-index="1"></a-plane>
        <a-gltf-model id="model2"
          gltf-model="#avatarModel2"
          position="0 0 0.1" 
          scale="0.6 0.6 0.6"
          rotation="0 180 0"
          animation-mixer
          class="clickable" data-target-index="1">
        </a-gltf-model>
      </a-entity>
    </a-scene>

    <!-- Script para alternar modelos al tocar el target -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const targets = [
          {
            entity: document.querySelector("#target0"),
            model: document.querySelector("#model1"),
            original: "#avatarModel1",
            originalScale: "0.7 0.7 0.7",
            toggled: false,
            visible: false
          },
          {
            entity: document.querySelector("#target1"),
            model: document.querySelector("#model2"),
            original: "#avatarModel2",
            originalScale: "0.6 0.6 0.6",
            toggled: false,
            visible: false
          }
        ];

        const tapHint = document.querySelector("#tap-hint");
        const altModel = "#avatarModel3";
        const pokeballScale = "0.3 0.3 0.3";

        // Configurar eventos para cada target
        targets.forEach((target, index) => {
          // Eventos de MindAR
          target.entity.addEventListener("targetFound", () => {
            target.visible = true;
            tapHint.style.display = "block";
            console.log("Target", index, "encontrado");
          });
          
          target.entity.addEventListener("targetLost", () => {
            target.visible = false;
            // Ocultar hint si ningún target está visible
            if (!targets.some(t => t.visible)) {
              tapHint.style.display = "none";
            }
            console.log("Target", index, "perdido");
          });

          // Hacer que tanto el plano como el modelo sean clickeables
          const clickableElements = target.entity.querySelectorAll('.clickable');
          clickableElements.forEach(element => {
            element.addEventListener('click', () => {
              if (target.visible) {
                console.log("Click en target", index);
                toggleModel(target);
              }
            });
            
            // Eventos táctiles para móviles
            element.addEventListener('touchstart', (e) => {
              if (target.visible) {
                e.preventDefault();
                console.log("Touch en target", index);
                toggleModel(target);
              }
            });
          });
        });

        // Función para alternar modelos
        function toggleModel(target) {
          target.toggled = !target.toggled;
          const newModel = target.toggled ? altModel : target.original;
          const newScale = target.toggled ? pokeballScale : target.originalScale;
          
          console.log("Cambiando modelo:", target.toggled ? "Pokebola" : "Original");
          
          // Cambiar el modelo y escala
          target.model.setAttribute("gltf-model", newModel);
          target.model.setAttribute("scale", newScale);
          
          // Pequeña animación de feedback
          const currentScale = target.model.getAttribute("scale");
          target.model.setAttribute("scale", {
            x: currentScale.x * 0.9,
            y: currentScale.y * 0.9,
            z: currentScale.z * 0.9
          });
          
          setTimeout(() => {
            target.model.setAttribute("scale", newScale);
          }, 100);
        }

        // También permitir tap en toda la escena para móviles
        const scene = document.querySelector('a-scene');
        scene.addEventListener('touchstart', (e) => {
          // Solo procesar si es un tap simple (no un swipe)
          if (e.touches.length === 1) {
            // Verificar si algún target está visible
            const visibleTarget = targets.find(t => t.visible);
            if (visibleTarget) {
              console.log("Touch general en escena, target visible encontrado");
              toggleModel(visibleTarget);
            }
          }
        });

        // Log inicial
        console.log("Script AR cargado correctamente");
        console.log("Targets configurados:", targets.length);
      });
    </script>
  </body>
</html>
